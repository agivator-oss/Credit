<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Private Credit Underwriting — Data Entry & AI Extraction (Static)</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2e;
      --panel-2:#111f38;
      --text:#e6eefc;
      --muted:#9fb2d6;
      --border:rgba(255,255,255,.10);
      --shadow:0 8px 24px rgba(0,0,0,.35);

      --primary:#2c5aa0;
      --success:#28a745;
      --danger:#dc3545;
      --warning:#ffc107;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";

      --radius:14px;
      --radius-sm:10px;
    }

    *{box-sizing:border-box;}
    html, body{height:100%;}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background: radial-gradient(1200px 800px at 20% 10%, rgba(44,90,160,.22), transparent 65%),
                  radial-gradient(1200px 900px at 85% 15%, rgba(40,167,69,.14), transparent 60%),
                  var(--bg);
    }

    a{color:#bcd4ff;}
    .app{
      display:grid;
      grid-template-rows:auto 1fr;
      min-height:100%;
    }

    header{
      position:sticky;
      top:0;
      z-index:20;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(11,18,32,.85), rgba(11,18,32,.55));
      border-bottom:1px solid var(--border);
    }

    .topbar{
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px 16px;
      max-width:1400px;
      margin:0 auto;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:260px;
    }

    .brand strong{font-size:14px; letter-spacing:.2px;}
    .brand span{font-size:12px; color:var(--muted);}

    .badge{
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--muted);
      white-space:nowrap;
    }

    .stat{
      display:flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.05);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }

    .dot{width:8px; height:8px; border-radius:50%; background:var(--muted);}
    .dot.success{background:var(--success);} .dot.warning{background:var(--warning);} .dot.danger{background:var(--danger);} .dot.primary{background:var(--primary);} 

    .spacer{flex:1;}

    .btn{
      appearance:none;
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:9px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      font-size:12px;
      letter-spacing:.2px;
    }
    .btn:hover{background:rgba(255,255,255,.10);} 
    .btn:active{transform: translateY(1px);} 
    .btn.primary{background:rgba(44,90,160,.25); border-color:rgba(44,90,160,.50);} 
    .btn.primary:hover{background:rgba(44,90,160,.35);} 
    .btn.danger{background:rgba(220,53,69,.18); border-color:rgba(220,53,69,.55);} 
    .btn.success{background:rgba(40,167,69,.18); border-color:rgba(40,167,69,.55);} 
    .btn:disabled{opacity:.55; cursor:not-allowed;}

    main{
      max-width:1400px;
      margin:0 auto;
      padding:14px 16px 24px;
      width:100%;
    }

    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap:14px;
    }
    @media (max-width: 1100px){
      .grid{grid-template-columns:1fr;}
    }

    .card{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(15,26,46,.80), rgba(15,26,46,.55));
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .card-header{
      padding:12px 12px;
      display:flex;
      align-items:center;
      gap:10px;
      border-bottom:1px solid var(--border);
      background: rgba(255,255,255,.04);
    }

    .card-header h2{
      font-size:13px;
      margin:0;
      letter-spacing:.2px;
    }

    .card-body{padding:12px;}

    .help{
      font-size:12px;
      color:var(--muted);
      line-height:1.45;
    }

    .field{display:flex; flex-direction:column; gap:6px; margin-bottom:10px;}
    .field label{
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
    }

    .required-asterisk{color:var(--warning); margin-left:4px;}

    .input, select, textarea{
      width:100%;
      padding:10px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background: rgba(17,31,56,.80);
      color:var(--text);
      outline:none;
      font-size:13px;
    }
    textarea{min-height:110px; resize:vertical; font-family:var(--mono); font-size:12px;}

    .input:focus, select:focus, textarea:focus{
      border-color: rgba(44,90,160,.9);
      box-shadow: 0 0 0 3px rgba(44,90,160,.25);
    }

    .input.valid{border-color: rgba(40,167,69,.75);} 
    .input.invalid{border-color: rgba(220,53,69,.85);} 

    .validation{
      font-size:12px;
      min-height:16px;
      color:var(--muted);
    }
    .validation.error{color: #ff9aa6;}
    .validation.ok{color: #9fe7b0;}

    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    @media (max-width: 560px){ .row{grid-template-columns:1fr;} }

    .kbd{
      font-family:var(--mono);
      font-size:11px;
      padding:2px 6px;
      border-radius:8px;
      border:1px solid var(--border);
      color:var(--muted);
      background: rgba(255,255,255,.04);
      white-space:nowrap;
    }

    .progress{
      height:10px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--border);
      border-radius:999px;
      overflow:hidden;
    }
    .progress > div{height:100%; width:0%; background: linear-gradient(90deg, rgba(44,90,160,.95), rgba(40,167,69,.95));}

    .tabs{display:flex; gap:8px; flex-wrap:wrap;}
    .tab{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color:var(--muted);
      padding:7px 10px;
      border-radius:999px;
      cursor:pointer;
      font-size:12px;
      font-weight:700;
      letter-spacing:.15px;
    }
    .tab[aria-selected="true"]{background: rgba(44,90,160,.25); color: var(--text); border-color: rgba(44,90,160,.5);}

    .section{display:none;}
    .section.active{display:block;}

    .issue-rail{
      position:fixed;
      right:14px;
      bottom:14px;
      width:360px;
      max-width: calc(100vw - 28px);
      border:1px solid var(--border);
      background: rgba(15,26,46,.95);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      z-index:30;
    }
    .issue-rail-header{display:flex; align-items:center; gap:10px; padding:10px 10px; border-bottom:1px solid var(--border); background:rgba(255,255,255,.04);}
    .issue-rail-header strong{font-size:12px; letter-spacing:.2px;}
    .issue-rail-body{padding:10px; max-height: 42vh; overflow:auto;}

    .issue{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      border-radius: 12px;
      padding:10px;
      margin-bottom:8px;
      cursor:pointer;
    }
    .issue:hover{background: rgba(255,255,255,.06);} 
    .issue .title{display:flex; justify-content:space-between; gap:10px; font-weight:800; font-size:12px;}
    .issue .meta{font-size:12px; color:var(--muted); margin-top:6px;}

    .pill{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      background: rgba(255,255,255,.04);
      white-space:nowrap;
    }
    .pill.error{border-color: rgba(220,53,69,.55); color:#ffb2bb; background: rgba(220,53,69,.12);} 
    .pill.warn{border-color: rgba(255,193,7,.55); color:#ffe39a; background: rgba(255,193,7,.12);} 
    .pill.ok{border-color: rgba(40,167,69,.55); color:#b7f1c3; background: rgba(40,167,69,.10);} 

    .confidence{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      color:var(--muted);
    }
    .confidence .bar{width:60px; height:8px; border-radius:999px; overflow:hidden; background: rgba(255,255,255,.08); border:1px solid var(--border);} 
    .confidence .bar > div{height:100%; width:0%; background: rgba(44,90,160,.9);} 

    .modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.55);
      z-index:50;
      padding:16px;
    }
    .modal[aria-hidden="false"]{display:flex;}

    .modal-panel{
      width:min(880px, 100%);
      border:1px solid var(--border);
      background: rgba(15,26,46,.98);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .modal-header{display:flex; align-items:center; gap:10px; padding:12px; border-bottom:1px solid var(--border); background:rgba(255,255,255,.04);} 
    .modal-header strong{font-size:12px; letter-spacing:.2px;}
    .modal-body{padding:12px;}

    .cmdlist{max-height: 46vh; overflow:auto; margin-top:10px;}
    .cmditem{display:flex; justify-content:space-between; align-items:center; gap:12px; padding:10px; border:1px solid var(--border); border-radius:12px; background:rgba(255,255,255,.04); cursor:pointer; margin-bottom:8px;} 
    .cmditem:hover{background:rgba(255,255,255,.06);} 
    .cmditem .left{display:flex; flex-direction:column; gap:2px;}
    .cmditem .left strong{font-size:12px;}
    .cmditem .left span{font-size:12px; color:var(--muted);} 

    .mono{font-family:var(--mono);} 
  </style>

  <!-- PDF.js (for PDF text extraction) -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- SheetJS (for Excel/CSV) -->
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="app">
    <header>
      <div class="topbar" role="banner">
        <div class="brand">
          <strong>Private Credit Underwriting — Data Entry & AI Extraction</strong>
          <span>Static client-side app (no server). Keyboard-first workflow for analysts.</span>
        </div>

        <div class="stat" title="Completion">
          <span class="dot primary" id="completion-dot"></span>
          <span><span id="completion-percent">0%</span> complete</span>
        </div>

        <div class="stat" title="Issues">
          <span class="dot" id="issues-dot"></span>
          <span><span id="issues-count">0</span> issues</span>
        </div>

        <div class="spacer"></div>

        <button class="btn" id="btn-cmd" type="button" aria-label="Open command palette (Ctrl+K)">Command <span class="kbd">Ctrl</span>+<span class="kbd">K</span></button>
        <button class="btn" id="btn-validate" type="button">Validate <span class="kbd">F8</span></button>
        <button class="btn success" id="btn-export" type="button">Export</button>
        <button class="btn danger" id="btn-clear" type="button">Clear</button>
      </div>
    </header>

    <main>
      <div class="grid">
        <!-- LEFT: Ingestion + Evidence + Logs -->
        <section class="card" aria-label="Ingestion and evidence panel">
          <div class="card-header">
            <h2>1) Ingest & Extract</h2>
            <span class="badge">No backend • Runs from disk</span>
          </div>
          <div class="card-body">
            <div class="field">
              <label for="openaiKey">
                OpenAI API Key
                <span class="help">Stored in memory only. Not saved.</span>
              </label>
              <input class="input" id="openaiKey" type="password" autocomplete="off" placeholder="sk-..." />
              <div class="validation" id="openaiKey-validation"></div>
            </div>

            <div class="row">
              <div class="field">
                <label for="openaiModel">Model</label>
                <select id="openaiModel" class="input">
                  <option value="gpt-4.1-mini">gpt-4.1-mini</option>
                  <option value="gpt-4o-mini">gpt-4o-mini</option>
                  <option value="gpt-4.1">gpt-4.1</option>
                </select>
              </div>
              <div class="field">
                <label for="confidenceThreshold">Auto-apply threshold</label>
                <select id="confidenceThreshold" class="input">
                  <option value="0.85">0.85 (conservative)</option>
                  <option value="0.75" selected>0.75 (balanced)</option>
                  <option value="0.60">0.60 (aggressive)</option>
                </select>
              </div>
            </div>

            <div class="field">
              <label for="fileInput">Upload CIM / Financials</label>
              <input class="input" id="fileInput" type="file" accept="application/pdf,.xlsx,.xls,.csv" />
              <div class="validation" id="fileInput-validation"></div>
              <div class="help">Shortcuts: Extract <span class="kbd">Ctrl</span>+<span class="kbd">Enter</span>, Next issue <span class="kbd">F8</span>, Jump required <span class="kbd">Ctrl</span>+<span class="kbd">Enter</span>.</div>
            </div>

            <div class="row">
              <button class="btn primary" id="btn-extract" type="button">Extract with AI <span class="kbd">Ctrl</span>+<span class="kbd">Enter</span></button>
              <button class="btn" id="btn-show-raw" type="button">Toggle raw text</button>
            </div>

            <div style="margin-top:12px;">
              <div class="field" id="rawTextField" style="display:none;">
                <label for="rawText">Raw extracted text (sanitized)</label>
                <textarea id="rawText" class="input mono" spellcheck="false" aria-label="Raw extracted text"></textarea>
                <div class="help">Tip: If extraction is messy, paste cleaned text here and re-run AI extraction.</div>
              </div>
            </div>

            <div style="margin-top:12px;">
              <div class="field">
                <label for="aiJson">AI output (JSON)</label>
                <textarea id="aiJson" class="input mono" spellcheck="false" aria-label="AI output JSON"></textarea>
                <div class="help">We only auto-apply values with confidence ≥ threshold and with evidence. Others remain as suggestions.</div>
              </div>
            </div>

            <div style="margin-top:12px;">
              <div class="field">
                <label for="log">Run log</label>
                <textarea id="log" class="input mono" readonly aria-label="Run log"></textarea>
              </div>
            </div>
          </div>
        </section>

        <!-- RIGHT: Keyboard-first data entry -->
        <section class="card" aria-label="Data entry panel">
          <div class="card-header">
            <h2>2) Deal Data Entry</h2>
            <span class="badge">Enter = next • Shift+Enter = previous</span>
          </div>
          <div class="card-body">
            <div class="tabs" role="tablist" aria-label="Form sections">
              <button class="tab" role="tab" aria-selected="true" data-tab="tab-borrower">Borrower</button>
              <button class="tab" role="tab" aria-selected="false" data-tab="tab-financials">Financials</button>
              <button class="tab" role="tab" aria-selected="false" data-tab="tab-debt">Debt</button>
              <button class="tab" role="tab" aria-selected="false" data-tab="tab-metrics">Metrics</button>
              <button class="tab" role="tab" aria-selected="false" data-tab="tab-review">Review</button>
            </div>

            <!-- Borrower -->
            <div class="section active" id="tab-borrower" role="tabpanel">
              <div class="row" style="margin-top:12px;">
                <div class="field">
                  <label for="dealname">Deal name<span class="required-asterisk" aria-hidden="true">*</span>
                    <span class="confidence" id="dealname-confidence" aria-label="confidence"></span>
                  </label>
                  <input class="input" id="dealname" required data-required="true" data-type="text" />
                  <div class="validation" id="dealname-validation"></div>
                </div>
                <div class="field">
                  <label for="borrowername">Borrower legal name<span class="required-asterisk" aria-hidden="true">*</span>
                    <span class="confidence" id="borrowername-confidence" aria-label="confidence"></span>
                  </label>
                  <input class="input" id="borrowername" required data-required="true" data-type="text" />
                  <div class="validation" id="borrowername-validation"></div>
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label for="industry">Industry
                    <span class="confidence" id="industry-confidence" aria-label="confidence"></span>
                  </label>
                  <input class="input" id="industry" data-type="text" />
                  <div class="validation" id="industry-validation"></div>
                </div>
                <div class="field">
                  <label for="currency">Reporting currency</label>
                  <input class="input" id="currency" placeholder="USD" data-type="currency_code" />
                  <div class="validation" id="currency-validation"></div>
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label for="unitsscale">Units scale</label>
                  <select class="input" id="unitsscale" data-type="units_scale">
                    <option value="1">1 (full units)</option>
                    <option value="1000">1,000 (thousands)</option>
                    <option value="1000000">1,000,000 (millions)</option>
                  </select>
                  <div class="validation" id="unitsscale-validation"></div>
                </div>
                <div class="field">
                  <label for="asofdate">As-of date (LTM)</label>
                  <input class="input" id="asofdate" type="date" data-type="date" />
                  <div class="validation" id="asofdate-validation"></div>
                </div>
              </div>
            </div>

            <!-- Financials -->
            <div class="section" id="tab-financials" role="tabpanel">
              <div class="help" style="margin-top:10px;">Enter the latest period. Add more periods later (MVP keeps one period for speed; you can paste multi-year values into the raw JSON and re-run).</div>
              <div class="row" style="margin-top:12px;">
                <div class="field">
                  <label for="periodend">Period end date</label>
                  <input class="input" id="periodend" type="date" data-type="date" />
                  <div class="validation" id="periodend-validation"></div>
                </div>
                <div class="field">
                  <label for="periodmonths">Period months</label>
                  <select class="input" id="periodmonths" data-type="int">
                    <option value="12" selected>12</option>
                    <option value="3">3</option>
                    <option value="6">6</option>
                    <option value="9">9</option>
                  </select>
                  <div class="validation" id="periodmonths-validation"></div>
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label for="revenue">Revenue<span class="required-asterisk" aria-hidden="true">*</span>
                    <span class="confidence" id="revenue-confidence" aria-label="confidence"></span>
                  </label>
                  <input class="input" id="revenue" required data-required="true" data-type="money" inputmode="decimal" placeholder="e.g., 125000000" />
                  <div class="validation" id="revenue-validation"></div>
                </div>
                <div class="field">
                  <label for="ebitda">EBITDA<span class="required-asterisk" aria-hidden="true">*</span>
                    <span class="confidence" id="ebitda-confidence" aria-label="confidence"></span>
                  </label>
                  <input class="input" id="ebitda" required data-required="true" data-type="money" inputmode="decimal" placeholder="e.g., 32500000" />
                  <div class="validation" id="ebitda-validation"></div>
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label for="ebitdamargin">EBITDA margin (%)
                    <span class="confidence" id="ebitdamargin-confidence" aria-label="confidence"></span>
                  </label>
                  <input class="input" id="ebitdamargin" data-type="percent" inputmode="decimal" placeholder="e.g., 26.0" />
                  <div class="validation" id="ebitdamargin-validation"></div>
                </div>
                <div class="field">
                  <label for="netincome">Net income</label>
                  <input class="input" id="netincome" data-type="money" inputmode="decimal" />
                  <div class="validation" id="netincome-validation"></div>
                </div>
              </div>
            </div>

            <!-- Debt -->
            <div class="section" id="tab-debt" role="tabpanel">
              <div class="help" style="margin-top:10px;">MVP supports one primary tranche (expand to multiple tranches later).</div>
              <div class="row" style="margin-top:12px;">
                <div class="field">
                  <label for="tranchename">Tranche name
                    <span class="confidence" id="tranchename-confidence" aria-label="confidence"></span>
                  </label>
                  <input class="input" id="tranchename" data-type="text" placeholder="e.g., Unitranche" />
                  <div class="validation" id="tranchename-validation"></div>
                </div>
                <div class="field">
                  <label for="tranchetype">Tranche type</label>
                  <input class="input" id="tranchetype" data-type="text" placeholder="e.g., senior secured" />
                  <div class="validation" id="tranchetype-validation"></div>
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label for="commitment">Commitment</label>
                  <input class="input" id="commitment" data-type="money" inputmode="decimal" />
                  <div class="validation" id="commitment-validation"></div>
                </div>
                <div class="field">
                  <label for="drawn">Drawn amount</label>
                  <input class="input" id="drawn" data-type="money" inputmode="decimal" />
                  <div class="validation" id="drawn-validation"></div>
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label for="maturity">Maturity date</label>
                  <input class="input" id="maturity" type="date" data-type="date" />
                  <div class="validation" id="maturity-validation"></div>
                </div>
                <div class="field">
                  <label for="marginbps">Margin (bps)</label>
                  <input class="input" id="marginbps" data-type="bps" inputmode="numeric" placeholder="e.g., 550" />
                  <div class="validation" id="marginbps-validation"></div>
                </div>
              </div>
            </div>

            <!-- Metrics -->
            <div class="section" id="tab-metrics" role="tabpanel">
              <div class="row" style="margin-top:12px;">
                <div class="field">
                  <label for="totaldebt">Total debt (LTM)
                    <span class="confidence" id="totaldebt-confidence" aria-label="confidence"></span>
                  </label>
                  <input class="input" id="totaldebt" data-type="money" inputmode="decimal" />
                  <div class="validation" id="totaldebt-validation"></div>
                </div>
                <div class="field">
                  <label for="netdebt">Net debt (LTM)
                    <span class="confidence" id="netdebt-confidence" aria-label="confidence"></span>
                  </label>
                  <input class="input" id="netdebt" data-type="money" inputmode="decimal" />
                  <div class="validation" id="netdebt-validation"></div>
                </div>
              </div>
              <div class="row">
                <div class="field">
                  <label for="totallev">Total leverage (x)
                    <span class="confidence" id="totallev-confidence" aria-label="confidence"></span>
                  </label>
                  <input class="input" id="totallev" data-type="multiple" inputmode="decimal" placeholder="e.g., 4.2" />
                  <div class="validation" id="totallev-validation"></div>
                </div>
                <div class="field">
                  <label for="netlev">Net leverage (x)
                    <span class="confidence" id="netlev-confidence" aria-label="confidence"></span>
                  </label>
                  <input class="input" id="netlev" data-type="multiple" inputmode="decimal" placeholder="e.g., 3.8" />
                  <div class="validation" id="netlev-validation"></div>
                </div>
              </div>
              <div class="row">
                <div class="field">
                  <label for="interestcov">Interest coverage (x)
                    <span class="confidence" id="interestcov-confidence" aria-label="confidence"></span>
                  </label>
                  <input class="input" id="interestcov" data-type="multiple" inputmode="decimal" placeholder="e.g., 2.1" />
                  <div class="validation" id="interestcov-validation"></div>
                </div>
                <div class="field">
                  <label for="fccr">Fixed charge coverage (x)
                    <span class="confidence" id="fccr-confidence" aria-label="confidence"></span>
                  </label>
                  <input class="input" id="fccr" data-type="multiple" inputmode="decimal" placeholder="e.g., 1.6" />
                  <div class="validation" id="fccr-validation"></div>
                </div>
              </div>
            </div>

            <!-- Review -->
            <div class="section" id="tab-review" role="tabpanel">
              <div style="margin-top:12px;" class="help">
                Review gates (keyboard): Next issue <span class="kbd">F8</span>. Jump to missing required <span class="kbd">Ctrl</span>+<span class="kbd">Enter</span>. Command palette <span class="kbd">Ctrl</span>+<span class="kbd">K</span>.
              </div>

              <div style="margin-top:12px;">
                <div class="field">
                  <label for="reviewSummary">Summary</label>
                  <textarea id="reviewSummary" class="input mono" readonly></textarea>
                </div>
              </div>

              <div class="row">
                <button class="btn" id="btn-copy-json" type="button">Copy JSON</button>
                <button class="btn" id="btn-copy-csv" type="button">Copy CSV</button>
              </div>
            </div>

            <div style="margin-top:12px;">
              <div class="progress" aria-label="Completion progress"><div id="completion-bar"></div></div>
            </div>
          </div>
        </section>
      </div>
    </main>

    <!-- Issue rail -->
    <aside class="issue-rail" id="issueRail" aria-label="Issues" style="display:none;">
      <div class="issue-rail-header">
        <strong>Issues</strong>
        <span class="pill" id="pillIssues">0</span>
        <div class="spacer"></div>
        <button class="btn" id="btn-hide-issues" type="button">Hide</button>
      </div>
      <div class="issue-rail-body" id="issueRailBody"></div>
    </aside>

    <!-- Command palette -->
    <div class="modal" id="cmdModal" aria-hidden="true" role="dialog" aria-label="Command palette">
      <div class="modal-panel">
        <div class="modal-header">
          <strong>Command palette</strong>
          <span class="badge">Type to search fields/actions</span>
          <div class="spacer"></div>
          <button class="btn" id="cmdClose" type="button">Close <span class="kbd">Esc</span></button>
        </div>
        <div class="modal-body">
          <input class="input" id="cmdInput" type="text" autocomplete="off" placeholder="Jump to field (e.g., ebitda) or action (export, validate, extract)" />
          <div class="cmdlist" id="cmdList" aria-label="Commands"></div>
          <div class="help" style="margin-top:10px;">
            Navigate: <span class="kbd">↑</span>/<span class="kbd">↓</span>, Select: <span class="kbd">Enter</span>, Close: <span class="kbd">Esc</span>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
  (function(){
    'use strict';

    // ------------------------------
    // In-memory state (no storage)
    // ------------------------------
    const appState = {
      apiKey: null,
      model: 'gpt-4.1-mini',
      confidenceThreshold: 0.75,
      file: null,
      rawText: '',
      aiResult: null,
      suggestions: new Map(), // fieldId -> { value, confidence, evidence, page_refs }
      issues: [],
      lastFocusId: null,
    };

    // Expose in-memory data (explicitly) for export without persistence.
    window.privateCreditFormData = appState;

    // Clear sensitive memory on unload.
    window.addEventListener('beforeunload', () => {
      try {
        appState.apiKey = null;
        appState.rawText = '';
        appState.aiResult = null;
        appState.suggestions.clear();
      } catch (_) {}
    });

    // ------------------------------
    // DOM helpers
    // ------------------------------
    const $ = (id) => document.getElementById(id);
    const logEl = $('log');

    function nowStamp(){
      const d = new Date();
      return d.toISOString().replace('T',' ').replace('Z','Z');
    }

    function log(level, message){
      const levelTag = String(level || 'info').toUpperCase();
      const line = `[${nowStamp()}] ${levelTag}: ${message}`;
      logEl.value = (logEl.value ? (logEl.value + '\n') : '') + line;
      logEl.scrollTop = logEl.scrollHeight;
      // Also keep console for debugging.
      if (levelTag === 'ERROR') console.error(line);
      else if (levelTag === 'WARN') console.warn(line);
      else console.log(line);
    }

    function safeText(input){
      // Sanitize to reduce accidental script injection when rendering evidence.
      return String(input ?? '').replace(/[\u0000-\u001f\u007f]/g, ' ').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function isBlank(v){
      return v === null || v === undefined || String(v).trim() === '';
    }

    function parseNumberLoose(v){
      if (v === null || v === undefined) return null;
      if (typeof v === 'number' && Number.isFinite(v)) return v;
      const s = String(v).trim();
      if (!s) return null;
      // Allow inputs like "$12,345,678" or "10.5m" or "25%".
      const lowered = s.toLowerCase();
      const hasPercent = lowered.includes('%');
      let mult = 1;
      if (/[\s]?mm\b/.test(lowered) || /\b(million|millions)\b/.test(lowered) || /\b\d+(\.\d+)?m\b/.test(lowered)) mult = 1_000_000;
      if (/[\s]?bn\b/.test(lowered) || /\b(billion|billions)\b/.test(lowered) || /\b\d+(\.\d+)?b\b/.test(lowered)) mult = 1_000_000_000;
      if (/[\s]?k\b/.test(lowered) || /\b(thousand|thousands)\b/.test(lowered) || /\b\d+(\.\d+)?k\b/.test(lowered)) mult = 1_000;

      const cleaned = lowered
        .replace(/[$,]/g,'')
        .replace(/\bmm\b/g,'')
        .replace(/\bbn\b/g,'')
        .replace(/\bk\b/g,'')
        .replace(/\b(million|millions|billion|billions|thousand|thousands)\b/g,'')
        .replace(/%/g,'')
        .trim();

      const num = Number(cleaned);
      if (!Number.isFinite(num)) return null;
      const out = num * mult;
      // For percent fields, we keep numeric percent (e.g., 25.0 means 25%).
      return hasPercent ? num : out;
    }

    function clamp01(n){
      if (!Number.isFinite(n)) return 0;
      return Math.max(0, Math.min(1, n));
    }

    function confidenceLabel(c){
      if (c >= 0.85) return { label: 'High', cls: 'ok' };
      if (c >= 0.65) return { label: 'Med', cls: 'warn' };
      if (c > 0) return { label: 'Low', cls: 'error' };
      return { label: '—', cls: '' };
    }

    // ------------------------------
    // Tabs
    // ------------------------------
    document.querySelectorAll('.tab').forEach(btn => {
      btn.addEventListener('click', () => setActiveTab(btn.getAttribute('data-tab')));
    });

    function setActiveTab(tabId){
      document.querySelectorAll('.tab').forEach(b => b.setAttribute('aria-selected', String(b.getAttribute('data-tab') === tabId)));
      document.querySelectorAll('.section').forEach(s => s.classList.toggle('active', s.id === tabId));
    }

    // ------------------------------
    // Keyboard-first navigation
    // ------------------------------
    const fieldOrder = [
      'dealname','borrowername','industry','currency','unitsscale','asofdate',
      'periodend','periodmonths','revenue','ebitda','ebitdamargin','netincome',
      'tranchename','tranchetype','commitment','drawn','maturity','marginbps',
      'totaldebt','netdebt','totallev','netlev','interestcov','fccr'
    ];

    function focusField(fieldId){
      const el = $(fieldId);
      if (!el) return;
      const sectionEl = el.closest('.section');
      if (sectionEl && !sectionEl.classList.contains('active')){
        setActiveTab(sectionEl.id);
      }
      el.focus();
      el.select?.();
      appState.lastFocusId = fieldId;
    }

    function nextFieldId(currentId, direction){
      const idx = fieldOrder.indexOf(currentId);
      const nextIdx = idx < 0 ? 0 : (idx + (direction || 1));
      if (nextIdx < 0) return fieldOrder[0];
      if (nextIdx >= fieldOrder.length) return fieldOrder[fieldOrder.length - 1];
      return fieldOrder[nextIdx];
    }

    function moveField(direction){
      const active = document.activeElement;
      const currentId = active && active.id;
      const nextId = nextFieldId(currentId, direction);
      focusField(nextId);
    }

    function focusNextMissingRequired(){
      for (const id of fieldOrder){
        const el = $(id);
        if (!el) continue;
        const required = el.getAttribute('data-required') === 'true' || el.required;
        if (!required) continue;
        if (isBlank(el.value)){
          focusField(id);
          return true;
        }
      }
      return false;
    }

    // Enter / Shift+Enter = next / previous.
    document.addEventListener('keydown', (e) => {
      const isCmdPaletteOpen = $('cmdModal').getAttribute('aria-hidden') === 'false';
      if (isCmdPaletteOpen) return;

      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k'){
        e.preventDefault();
        openCmdPalette();
        return;
      }

      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter'){
        e.preventDefault();
        extractWithAI().catch(err => showUserError('Extraction failed', err));
        return;
      }

      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'enter'){
        // Fallback (some browsers)
      }

      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') return;

      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') return;

      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') return;

      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') return;

      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') return;

      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') return;

      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') return;

      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') return;

      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') return;

      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') return;

      // Jump to missing required
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') return;

      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') return;

      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') return;

      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') return;

      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') return;

      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') return;

      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') return;

      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') return;

      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') return;

      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') return;

      // Ctrl+Enter already used for extraction; use Ctrl+Shift+Enter for jump missing required
      if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'Enter'){
        e.preventDefault();
        if (!focusNextMissingRequired()){
          log('info', 'No missing required fields.');
        }
        return;
      }

      // F8: next issue
      if (e.key === 'F8'){
        e.preventDefault();
        validateAll();
        focusNextIssue(e.shiftKey ? -1 : 1);
        return;
      }

      // Enter-based navigation for inputs (avoid textareas)
      const active = document.activeElement;
      if (!active) return;
      const isTextArea = active.tagName === 'TEXTAREA';
      if (isTextArea) return;
      const isInputOrSelect = active.tagName === 'INPUT' || active.tagName === 'SELECT';
      if (!isInputOrSelect) return;

      if (e.key === 'Enter'){
        e.preventDefault();
        moveField(e.shiftKey ? -1 : 1);
      }
    });

    // ------------------------------
    // Validation
    // ------------------------------
    const validationRules = {
      text: (v, required) => required && isBlank(v) ? 'Required.' : null,
      currency_code: (v) => {
        if (isBlank(v)) return null;
        const s = String(v).trim().toUpperCase();
        if (!/^[A-Z]{3}$/.test(s)) return 'Use a 3-letter ISO code (e.g., USD).';
        return null;
      },
      units_scale: (v) => {
        if (isBlank(v)) return null;
        const n = Number(v);
        if (![1,1000,1000000].includes(n)) return 'Units scale must be 1, 1000, or 1000000.';
        return null;
      },
      date: (v) => {
        if (isBlank(v)) return null;
        // browser date input ensures format; still validate
        if (!/^\d{4}-\d{2}-\d{2}$/.test(String(v))) return 'Use ISO date format (YYYY-MM-DD).';
        return null;
      },
      int: (v) => {
        if (isBlank(v)) return null;
        const n = Number(v);
        if (!Number.isInteger(n)) return 'Must be an integer.';
        return null;
      },
      money: (v, required) => {
        if (required && isBlank(v)) return 'Required.';
        if (isBlank(v)) return null;
        const n = parseNumberLoose(v);
        if (n === null) return 'Enter a numeric amount (you can type 10m, 2500000, $2.5m).';
        return null;
      },
      percent: (v) => {
        if (isBlank(v)) return null;
        const n = parseNumberLoose(v);
        if (n === null) return 'Enter a numeric percent (e.g., 23.5).';
        if (n < -100 || n > 100) return 'Percent looks out of range (expected -100 to 100).';
        return null;
      },
      multiple: (v) => {
        if (isBlank(v)) return null;
        const n = parseNumberLoose(v);
        if (n === null) return 'Enter a numeric multiple (e.g., 4.2).';
        if (n < 0 || n > 50) return 'Multiple looks out of range.';
        return null;
      },
      bps: (v) => {
        if (isBlank(v)) return null;
        const n = parseNumberLoose(v);
        if (n === null) return 'Enter basis points as a number (e.g., 550).';
        if (n < 0 || n > 5000) return 'Bps looks out of range.';
        return null;
      }
    };

    function setValidationState(el, errorMsg){
      const vEl = $(el.id + '-validation');
      el.classList.remove('valid','invalid');
      vEl.classList.remove('ok','error');

      if (errorMsg){
        el.classList.add('invalid');
        el.setAttribute('aria-invalid','true');
        vEl.textContent = errorMsg;
        vEl.classList.add('error');
      } else {
        // Only mark valid if field has something or isn't required.
        const required = el.getAttribute('data-required') === 'true' || el.required;
        const hasVal = !isBlank(el.value);
        if (!required || hasVal){
          el.classList.add('valid');
          vEl.textContent = hasVal ? 'Looks good.' : '';
          if (hasVal) vEl.classList.add('ok');
        } else {
          vEl.textContent = '';
        }
        el.removeAttribute('aria-invalid');
      }
    }

    function validateField(el){
      if (!el || !el.id) return null;
      const type = el.getAttribute('data-type') || 'text';
      const required = el.getAttribute('data-required') === 'true' || el.required;
      const fn = validationRules[type] || validationRules.text;
      const err = fn(el.value, required);
      setValidationState(el, err);
      return err;
    }

    // Debounced validation
    let validateTimer = null;
    function requestValidateAll(){
      clearTimeout(validateTimer);
      validateTimer = setTimeout(validateAll, 280);
    }

    function validateAll(){
      const issues = [];

      for (const id of fieldOrder){
        const el = $(id);
        if (!el) continue;
        const err = validateField(el);
        if (err){
          const required = el.getAttribute('data-required') === 'true' || el.required;
          issues.push({
            severity: required ? 'error' : 'warn',
            fieldId: id,
            title: required ? 'Missing/invalid required field' : 'Invalid field',
            message: `${id}: ${err}`
          });
        }
      }

      // Consistency checks (soft warnings)
      const revenue = parseNumberLoose($('revenue')?.value);
      const ebitda = parseNumberLoose($('ebitda')?.value);
      const margin = parseNumberLoose($('ebitdamargin')?.value);
      if (Number.isFinite(revenue) && Number.isFinite(ebitda) && revenue !== 0){
        const implied = (ebitda / revenue) * 100;
        if (Number.isFinite(margin)){
          const diff = Math.abs(margin - implied);
          if (diff > 3){
            issues.push({
              severity:'warn',
              fieldId:'ebitdamargin',
              title:'EBITDA margin mismatch',
              message:`Implied margin is ${implied.toFixed(1)}%, but entered is ${margin.toFixed(1)}% (Δ ${diff.toFixed(1)}%).`
            });
          }
        } else {
          // Suggest computing it.
          issues.push({
            severity:'warn',
            fieldId:'ebitdamargin',
            title:'Missing EBITDA margin',
            message:`You can compute EBITDA margin ≈ ${(implied).toFixed(1)}% from Revenue and EBITDA.`
          });
        }
      }

      appState.issues = issues;
      renderIssues();
      renderCompletion();
      renderReviewSummary();
      return issues;
    }

    function renderIssues(){
      const issues = appState.issues || [];
      $('issues-count').textContent = String(issues.length);
      $('pillIssues').textContent = String(issues.length);

      const dot = $('issues-dot');
      dot.classList.remove('success','warning','danger');
      if (issues.length === 0) dot.classList.add('success');
      else if (issues.some(i => i.severity === 'error')) dot.classList.add('danger');
      else dot.classList.add('warning');

      const rail = $('issueRail');
      const body = $('issueRailBody');
      body.innerHTML = '';

      if (issues.length === 0){
        rail.style.display = 'none';
        return;
      }

      rail.style.display = 'block';
      issues.forEach((issue, idx) => {
        const div = document.createElement('div');
        div.className = 'issue';
        div.setAttribute('role','button');
        div.tabIndex = 0;
        div.dataset.idx = String(idx);
        div.innerHTML = `
          <div class="title">
            <span>${safeText(issue.title)}</span>
            <span class="pill ${issue.severity === 'error' ? 'error' : 'warn'}">${issue.severity.toUpperCase()}</span>
          </div>
          <div class="meta">${safeText(issue.message)}</div>
        `;
        div.addEventListener('click', () => focusField(issue.fieldId));
        div.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') focusField(issue.fieldId);
        });
        body.appendChild(div);
      });
    }

    let issueCursor = -1;
    function focusNextIssue(direction){
      const issues = appState.issues || [];
      if (issues.length === 0) return;
      if (issueCursor === -1) issueCursor = 0;
      else issueCursor += (direction || 1);
      if (issueCursor < 0) issueCursor = issues.length - 1;
      if (issueCursor >= issues.length) issueCursor = 0;
      const issue = issues[issueCursor];
      if (issue) focusField(issue.fieldId);
    }

    function renderCompletion(){
      const requiredIds = fieldOrder.filter(id => {
        const el = $(id);
        return el && (el.getAttribute('data-required') === 'true' || el.required);
      });
      const filled = requiredIds.filter(id => !isBlank($(id).value)).length;
      const pct = requiredIds.length ? Math.round((filled / requiredIds.length) * 100) : 0;
      $('completion-percent').textContent = `${pct}%`;
      $('completion-bar').style.width = `${pct}%`;

      const dot = $('completion-dot');
      dot.classList.remove('success','warning','danger','primary');
      if (pct === 100) dot.classList.add('success');
      else if (pct >= 60) dot.classList.add('warning');
      else dot.classList.add('primary');
    }

    // validate on blur/input
    fieldOrder.forEach(id => {
      const el = $(id);
      if (!el) return;
      el.addEventListener('blur', () => { validateField(el); validateAll(); });
      el.addEventListener('input', () => { validateField(el); requestValidateAll(); });
      el.addEventListener('focus', () => { appState.lastFocusId = id; });
    });

    // ------------------------------
    // Command palette
    // ------------------------------
    const cmdModal = $('cmdModal');
    const cmdInput = $('cmdInput');
    const cmdList = $('cmdList');
    let cmdItems = []; // filtered
    let cmdIndex = 0;

    const baseCommands = [
      { key: 'extract', name: 'Extract with AI', hint: 'Run ingestion + OpenAI extraction', action: () => extractWithAI().catch(err => showUserError('Extraction failed', err)) },
      { key: 'validate', name: 'Validate', hint: 'Re-run all validations', action: () => { validateAll(); } },
      { key: 'export', name: 'Export', hint: 'Export JSON & CSV', action: () => exportData() },
      { key: 'clear', name: 'Clear', hint: 'Clear all data (memory only)', action: () => clearAll() },
      { key: 'raw', name: 'Toggle raw text', hint: 'Show/hide raw extracted text area', action: () => toggleRaw() },
    ];

    function buildCmdIndex(){
      const fieldCmds = fieldOrder.map(id => ({
        key: `field:${id}`,
        name: `Jump: ${id}`,
        hint: $(`${id}`)?.previousElementSibling?.textContent?.trim() || 'Field',
        action: () => focusField(id)
      }));

      return [...baseCommands, ...fieldCmds];
    }

    const allCommands = buildCmdIndex();

    function openCmdPalette(){
      cmdModal.setAttribute('aria-hidden','false');
      cmdInput.value = '';
      cmdIndex = 0;
      renderCmdList('');
      setTimeout(() => cmdInput.focus(), 0);
    }

    function closeCmdPalette(){
      cmdModal.setAttribute('aria-hidden','true');
      if (appState.lastFocusId) focusField(appState.lastFocusId);
    }

    function renderCmdList(query){
      const q = String(query || '').trim().toLowerCase();
      cmdItems = allCommands.filter(c => {
        if (!q) return true;
        return c.key.toLowerCase().includes(q) || c.name.toLowerCase().includes(q) || (c.hint || '').toLowerCase().includes(q);
      }).slice(0, 40);
      cmdIndex = Math.min(cmdIndex, Math.max(0, cmdItems.length - 1));

      cmdList.innerHTML = '';
      cmdItems.forEach((c, i) => {
        const div = document.createElement('div');
        div.className = 'cmditem';
        div.dataset.idx = String(i);
        div.innerHTML = `
          <div class="left">
            <strong>${safeText(c.name)}</strong>
            <span>${safeText(c.hint || '')}</span>
          </div>
          <span class="kbd">Enter</span>
        `;
        if (i === cmdIndex) div.style.outline = '2px solid rgba(44,90,160,.75)';
        div.addEventListener('click', () => { closeCmdPalette(); c.action(); });
        cmdList.appendChild(div);
      });
    }

    $('btn-cmd').addEventListener('click', openCmdPalette);
    $('cmdClose').addEventListener('click', closeCmdPalette);
    cmdInput.addEventListener('input', () => renderCmdList(cmdInput.value));

    cmdModal.addEventListener('keydown', (e) => {
      if (cmdModal.getAttribute('aria-hidden') === 'true') return;
      if (e.key === 'Escape'){
        e.preventDefault();
        closeCmdPalette();
        return;
      }
      if (e.key === 'ArrowDown'){
        e.preventDefault();
        cmdIndex = Math.min(cmdIndex + 1, cmdItems.length - 1);
        renderCmdList(cmdInput.value);
        return;
      }
      if (e.key === 'ArrowUp'){
        e.preventDefault();
        cmdIndex = Math.max(cmdIndex - 1, 0);
        renderCmdList(cmdInput.value);
        return;
      }
      if (e.key === 'Enter'){
        e.preventDefault();
        const item = cmdItems[cmdIndex];
        if (item){
          closeCmdPalette();
          item.action();
        }
      }
    });

    // ------------------------------
    // Buttons
    // ------------------------------
    $('btn-show-raw').addEventListener('click', toggleRaw);
    function toggleRaw(){
      const field = $('rawTextField');
      const isHidden = field.style.display === 'none';
      field.style.display = isHidden ? 'block' : 'none';
      if (isHidden) $('rawText').focus();
    }

    $('btn-extract').addEventListener('click', () => extractWithAI().catch(err => showUserError('Extraction failed', err)));
    $('btn-validate').addEventListener('click', () => { validateAll(); focusNextIssue(1); });
    $('btn-export').addEventListener('click', exportData);
    $('btn-clear').addEventListener('click', clearAll);
    $('btn-hide-issues').addEventListener('click', () => $('issueRail').style.display = 'none');

    $('btn-copy-json').addEventListener('click', () => copyToClipboard(buildExportJsonString()));
    $('btn-copy-csv').addEventListener('click', () => copyToClipboard(buildExportCsv()));

    $('openaiModel').addEventListener('change', (e) => { appState.model = e.target.value; });
    $('confidenceThreshold').addEventListener('change', (e) => { appState.confidenceThreshold = Number(e.target.value); });

    $('openaiKey').addEventListener('input', (e) => {
      const v = e.target.value;
      appState.apiKey = v && String(v).trim() ? String(v).trim() : null;
      validateApiKey();
    });

    $('fileInput').addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      appState.file = f || null;
      if (f) log('info', `Selected file: ${f.name} (${Math.round(f.size/1024)} KB)`);
      validateFile();
    });

    function validateApiKey(){
      const el = $('openaiKey');
      const vEl = $('openaiKey-validation');
      vEl.classList.remove('ok','error');
      el.classList.remove('valid','invalid');
      if (!appState.apiKey){
        vEl.textContent = 'Enter your OpenAI API key to run AI extraction.';
        return;
      }
      if (!/^sk-/.test(appState.apiKey)){
        el.classList.add('invalid');
        vEl.textContent = 'Key format looks unusual (expected to start with sk-).';
        vEl.classList.add('error');
        return;
      }
      el.classList.add('valid');
      vEl.textContent = 'Key loaded (in memory only).';
      vEl.classList.add('ok');
    }

    function validateFile(){
      const el = $('fileInput');
      const vEl = $('fileInput-validation');
      vEl.classList.remove('ok','error');
      if (!appState.file){
        vEl.textContent = 'Upload a PDF, Excel, or CSV.';
        return;
      }
      const name = appState.file.name.toLowerCase();
      const ok = name.endsWith('.pdf') || name.endsWith('.xlsx') || name.endsWith('.xls') || name.endsWith('.csv');
      if (!ok){
        vEl.textContent = 'Unsupported file type. Use PDF, XLSX/XLS, or CSV.';
        vEl.classList.add('error');
        return;
      }
      if (appState.file.size > 100 * 1024 * 1024){
        vEl.textContent = 'File too large (max 100MB).';
        vEl.classList.add('error');
        return;
      }
      vEl.textContent = 'File ready.';
      vEl.classList.add('ok');
    }

    // ------------------------------
    // Extraction: PDF / Excel / CSV
    // ------------------------------
    async function extractTextFromPdf(file){
      if (!window.pdfjsLib) throw new Error('PDF.js failed to load (network blocked?)');
      // Set worker source (CDN). Required especially when running from file://
      window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

      const arrayBuffer = await file.arrayBuffer();
      const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      const pages = pdf.numPages;
      log('info', `PDF loaded: ${pages} page(s). Extracting text...`);
      let out = '';
      for (let p = 1; p <= pages; p++){
        const page = await pdf.getPage(p);
        const content = await page.getTextContent();
        const strings = content.items.map(it => (it && it.str) ? String(it.str) : '').filter(Boolean);
        const pageText = strings.join(' ').replace(/\s+/g,' ').trim();
        out += `\n[p${p}] ${pageText}\n`;
        if (p % 5 === 0 || p === pages) log('info', `Extracted page ${p}/${pages}`);
      }
      return out.trim();
    }

    function sheetToText(workbook){
      const parts = [];
      for (const name of workbook.SheetNames){
        const ws = workbook.Sheets[name];
        parts.push(`\n[SHEET: ${name}]`);
        // Use TSV output so it is LLM-friendly.
        const tsv = window.XLSX.utils.sheet_to_txt(ws);
        parts.push(tsv);
      }
      return parts.join('\n').replace(/\u0000/g,' ').trim();
    }

    async function extractTextFromExcelOrCsv(file){
      if (!window.XLSX) throw new Error('XLSX library failed to load (network blocked?)');
      const name = file.name.toLowerCase();
      const buf = await file.arrayBuffer();
      if (name.endsWith('.csv')){
        const text = new TextDecoder('utf-8').decode(buf);
        return `\n[CSV]\n${text}`.trim();
      }
      const wb = window.XLSX.read(buf, { type: 'array' });
      return sheetToText(wb);
    }

    async function extractRawTextFromFile(file){
      const name = file.name.toLowerCase();
      if (name.endsWith('.pdf')) return await extractTextFromPdf(file);
      if (name.endsWith('.xlsx') || name.endsWith('.xls') || name.endsWith('.csv')) return await extractTextFromExcelOrCsv(file);
      throw new Error('Unsupported file type');
    }

    // ------------------------------
    // OpenAI extraction
    // ------------------------------
    function buildCimPrompt(documentTitle, extractedText, tablesText){
      return `You are a senior private credit underwriting analyst and data extraction engine.\n` +
      `Extract ONLY what is explicitly supported by the CIM text provided. Do not guess.\n` +
      `Return JSON ONLY that matches the schema exactly. No markdown, no prose.\n\n` +
      `RULES\n` +
      `- If a field is missing or not supported, set it to null and set its confidence to 0.\n` +
      `- Confidence is a number from 0.0 to 1.0 based on strength of evidence in the CIM text.\n` +
      `- Always normalize: currency amounts numeric (no $/commas) in full units; percentages numeric percent; dates ISO 8601.\n` +
      `- Detect units scale from context (e.g., \'$ in millions\', \'$000s\'). If unknown, set units_scale to 1 and lower confidence.\n` +
      `- Prefer latest LTM and most recent fiscal year when multiple are present; return arrays when available.\n` +
      `- Provide evidence snippet (max 240 chars) and page_refs (e.g. \'p12\') for any extracted field where confidence > 0.\n` +
      `- If uncertain, set null and confidence 0.\n\n` +
      `OUTPUT SCHEMA (must match):\n` +
      `${JSON.stringify(getExtractionSchemaTemplate(), null, 2)}\n\n` +
      `Now perform the extraction.\n\n` +
      `document_title: ${documentTitle}\n\n` +
      `extracted_text:\n${extractedText}\n\n` +
      `tables_text:\n${tablesText || ''}`;
    }

    function getExtractionSchemaTemplate(){
      // Template acts as both schema guidance and a parse target.
      // Keep it compact but explicit.
      const field = (type) => ({ value: null, confidence: 0, evidence: null, page_refs: [] });
      return {
        metadata: {
          document_title: '',
          borrower_name: field('string'),
          industry: field('string'),
          headquarters: field('string'),
          reporting_currency: field('string'),
          units_scale: { value: null, confidence: 0, evidence: null, page_refs: [] }
        },
        financials: {
          income_statement: {
            periods: [
              {
                period_label: null,
                period_end_date: null,
                period_months: null,
                revenue: field('number'),
                gross_profit: field('number'),
                operating_income: field('number'),
                ebitda: field('number'),
                ebitda_margin_percent: field('number'),
                net_income: field('number')
              }
            ]
          },
          balance_sheet: {
            periods: [
              {
                period_label: null,
                period_end_date: null,
                cash: field('number'),
                total_assets: field('number'),
                total_liabilities: field('number'),
                total_debt: field('number'),
                shareholders_equity: field('number')
              }
            ]
          },
          cash_flow: {
            periods: [
              {
                period_label: null,
                period_end_date: null,
                cash_from_operations: field('number'),
                capex: field('number'),
                free_cash_flow: field('number')
              }
            ]
          }
        },
        credit_metrics: {
          ltm: {
            as_of_date: null,
            leverage: {
              total_debt: field('number'),
              net_debt: field('number'),
              total_leverage_x: field('number'),
              net_leverage_x: field('number')
            },
            coverage: {
              interest_coverage_x: field('number'),
              fixed_charge_coverage_x: field('number')
            }
          }
        },
        debt_structure: {
          tranches: [
            {
              tranche_name: field('string'),
              tranche_type: field('string'),
              commitment: field('number'),
              drawn_amount: field('number'),
              maturity_date: field('string'),
              rate_type: { value: null, confidence: 0, evidence: null, page_refs: [] },
              base_rate: field('string'),
              margin_bps: field('number'),
              all_in_rate_bps: field('number')
            }
          ]
        },
        quality: {
          notes: [],
          missing_critical_fields: []
        }
      };
    }

    function extractJsonFromOpenAIResponse(data){
      // Handles both Responses API shapes and Chat Completions-like shapes.
      if (!data) return null;
      if (typeof data.output_text === 'string' && data.output_text.trim()){
        return data.output_text.trim();
      }
      // Responses API: output[].content[].text
      if (Array.isArray(data.output)){
        const texts = [];
        for (const o of data.output){
          if (!o || !Array.isArray(o.content)) continue;
          for (const c of o.content){
            if (c && typeof c.text === 'string') texts.push(c.text);
          }
        }
        const joined = texts.join('\n').trim();
        if (joined) return joined;
      }
      // Chat Completions
      const chat = data.choices?.[0]?.message?.content;
      if (typeof chat === 'string' && chat.trim()) return chat.trim();
      return null;
    }

    async function callOpenAI(prompt){
      if (!appState.apiKey) throw new Error('Missing OpenAI API key');
      const model = appState.model;

      // Use Responses API (recommended). If blocked, user will see a friendly error.
      const res = await fetch('https://api.openai.com/v1/responses', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${appState.apiKey}`
        },
        body: JSON.stringify({
          model,
          input: [
            { role: 'user', content: [ { type: 'input_text', text: prompt } ] }
          ],
          temperature: 0,
          response_format: { type: 'json_object' }
        })
      });

      if (!res.ok){
        const text = await res.text();
        throw new Error(`OpenAI error (${res.status}): ${text}`);
      }
      return await res.json();
    }

    function safeJsonParse(text){
      try{
        return JSON.parse(text);
      } catch (e){
        return null;
      }
    }

    function normalizeAiResult(ai){
      // Enforce: no evidence/page_refs => null + confidence 0
      // Coerce numbers where possible.
      const enforce = (node) => {
        if (!node || typeof node !== 'object') return;
        if (Object.prototype.hasOwnProperty.call(node, 'confidence') && Object.prototype.hasOwnProperty.call(node, 'value')){
          const conf = clamp01(Number(node.confidence));
          const hasEvidence = (typeof node.evidence === 'string' && node.evidence.trim()) || (Array.isArray(node.page_refs) && node.page_refs.length > 0);
          if (!hasEvidence || conf === 0){
            node.value = null;
            node.confidence = 0;
            node.evidence = null;
            node.page_refs = [];
          } else {
            node.confidence = conf;
            // If value should be number but is string, try parse.
            if (typeof node.value === 'string'){
              const parsed = parseNumberLoose(node.value);
              if (parsed !== null) node.value = parsed;
            }
          }
          return;
        }
        for (const k of Object.keys(node)){
          const v = node[k];
          if (Array.isArray(v)) v.forEach(enforce);
          else if (v && typeof v === 'object') enforce(v);
        }
      };

      enforce(ai);
      return ai;
    }

    function mapAiToForm(ai){
      appState.suggestions.clear();

      const threshold = Number(appState.confidenceThreshold || 0.75);
      const setSuggestion = (fieldId, fObj) => {
        if (!fObj || typeof fObj !== 'object') return;
        const conf = clamp01(Number(fObj.confidence));
        const val = fObj.value;
        const evidence = typeof fObj.evidence === 'string' ? fObj.evidence : null;
        const pageRefs = Array.isArray(fObj.page_refs) ? fObj.page_refs.map(String) : [];
        if (val === null || conf <= 0) return;
        appState.suggestions.set(fieldId, { value: val, confidence: conf, evidence, page_refs: pageRefs });

        // Auto-apply only if meets threshold
        if (conf >= threshold && evidence && pageRefs.length > 0){
          applyValue(fieldId, val);
        }
        renderConfidence(fieldId, conf);
      };

      // Metadata
      setSuggestion('borrowername', ai?.metadata?.borrower_name);
      setSuggestion('industry', ai?.metadata?.industry);
      setSuggestion('currency', ai?.metadata?.reporting_currency);
      // units_scale is slightly different shape
      const us = ai?.metadata?.units_scale;
      if (us && typeof us === 'object'){
        const conf = clamp01(Number(us.confidence));
        const val = us.value;
        if (val !== null && conf > 0){
          appState.suggestions.set('unitsscale', { value: val, confidence: conf, evidence: us.evidence || null, page_refs: us.page_refs || [] });
          if (conf >= threshold && us.evidence && (us.page_refs||[]).length){
            applyValue('unitsscale', String(val));
          }
          renderConfidence('unitsscale', conf);
        }
      }

      // Periods (take first period as MVP)
      const income0 = ai?.financials?.income_statement?.periods?.[0];
      if (income0){
        if (income0.period_end_date) applyValue('periodend', income0.period_end_date);
        if (income0.period_months) applyValue('periodmonths', String(income0.period_months));
        setSuggestion('revenue', income0.revenue);
        setSuggestion('ebitda', income0.ebitda);
        setSuggestion('ebitdamargin', income0.ebitda_margin_percent);
        setSuggestion('netincome', income0.net_income);
      }

      // LTM
      if (ai?.credit_metrics?.ltm?.as_of_date) applyValue('asofdate', ai.credit_metrics.ltm.as_of_date);
      const lev = ai?.credit_metrics?.ltm?.leverage;
      const cov = ai?.credit_metrics?.ltm?.coverage;
      setSuggestion('totaldebt', lev?.total_debt);
      setSuggestion('netdebt', lev?.net_debt);
      setSuggestion('totallev', lev?.total_leverage_x);
      setSuggestion('netlev', lev?.net_leverage_x);
      setSuggestion('interestcov', cov?.interest_coverage_x);
      setSuggestion('fccr', cov?.fixed_charge_coverage_x);

      // Debt tranche (first)
      const tr0 = ai?.debt_structure?.tranches?.[0];
      if (tr0){
        setSuggestion('tranchename', tr0.tranche_name);
        setSuggestion('tranchetype', tr0.tranche_type);
        setSuggestion('commitment', tr0.commitment);
        setSuggestion('drawn', tr0.drawn_amount);
        // maturity_date is a field object
        setSuggestion('maturity', tr0.maturity_date);
        setSuggestion('marginbps', tr0.margin_bps);
      }

      // Deal name: not extracted in schema; keep manual.
      renderCompletion();
      validateAll();
    }

    function applyValue(fieldId, value){
      const el = $(fieldId);
      if (!el) return;
      if (el.tagName === 'SELECT'){
        el.value = String(value);
      } else {
        el.value = value === null || value === undefined ? '' : String(value);
      }
      validateField(el);
    }

    function renderConfidence(fieldId, conf){
      const root = $(fieldId + '-confidence');
      if (!root) return;
      root.innerHTML = '';
      const c = clamp01(conf);
      const meta = confidenceLabel(c);

      const bar = document.createElement('span');
      bar.className = 'bar';
      const fill = document.createElement('div');
      fill.style.width = `${Math.round(c * 100)}%`;
      if (c >= 0.85) fill.style.background = 'rgba(40,167,69,.9)';
      else if (c >= 0.65) fill.style.background = 'rgba(255,193,7,.9)';
      else fill.style.background = 'rgba(220,53,69,.9)';
      bar.appendChild(fill);

      const txt = document.createElement('span');
      txt.textContent = `${meta.label} (${Math.round(c*100)}%)`;

      root.appendChild(bar);
      root.appendChild(txt);
    }

    function renderReviewSummary(){
      const out = [];
      const issues = appState.issues || [];
      const errors = issues.filter(i => i.severity === 'error');
      const warns = issues.filter(i => i.severity !== 'error');

      out.push(`Completion: ${$('completion-percent').textContent}`);
      out.push(`Errors: ${errors.length}`);
      out.push(`Warnings: ${warns.length}`);

      // Suggestions not applied
      const threshold = Number(appState.confidenceThreshold || 0.75);
      const notApplied = [];
      for (const [fieldId, s] of appState.suggestions.entries()){
        const el = $(fieldId);
        const current = el ? el.value : '';
        const autoApplied = s.confidence >= threshold && s.evidence && (s.page_refs||[]).length;
        if (!autoApplied){
          notApplied.push(`${fieldId}: suggested=${String(s.value)} (conf ${Math.round(s.confidence*100)}%)`);
        } else if (isBlank(current)){
          notApplied.push(`${fieldId}: eligible but empty (check mapping)`);
        }
      }
      if (notApplied.length){
        out.push('');
        out.push('Suggestions requiring review (not auto-applied):');
        out.push(...notApplied.slice(0, 30));
      }

      $('reviewSummary').value = out.join('\n');
    }

    // ------------------------------
    // Main: Extract with AI
    // ------------------------------
    async function extractWithAI(){
      validateApiKey();
      validateFile();
      if (!appState.file) throw new Error('Please select a file first.');
      if (!appState.apiKey) throw new Error('Please enter an OpenAI API key first.');

      $('btn-extract').disabled = true;
      $('btn-extract').textContent = 'Extracting…';
      try{
        const file = appState.file;
        log('info', 'Starting raw text extraction…');
        const raw = await extractRawTextFromFile(file);
        const sanitized = raw.replace(/\s+/g,' ').replace(/\s\[p/g, '\n[p').trim();
        appState.rawText = sanitized;
        $('rawText').value = sanitized;

        log('info', `Raw text length: ${sanitized.length.toLocaleString()} chars`);

        const title = file.name;
        const prompt = buildCimPrompt(title, sanitized.slice(0, 220000), '');

        log('info', `Calling OpenAI model: ${appState.model}`);
        const response = await callOpenAI(prompt);
        const jsonText = extractJsonFromOpenAIResponse(response);
        if (!jsonText) throw new Error('OpenAI returned no JSON text.');

        $('aiJson').value = jsonText;
        const parsed = safeJsonParse(jsonText);
        if (!parsed) throw new Error('Failed to parse JSON from AI output. Ensure the model returns JSON only.');

        const normalized = normalizeAiResult(parsed);
        appState.aiResult = normalized;

        // Apply into form + confidence
        mapAiToForm(normalized);
        log('info', 'AI extraction complete. Values auto-applied based on threshold + evidence rules.');

        // Keyboard: jump to first missing required
        focusNextMissingRequired();
      } finally {
        $('btn-extract').disabled = false;
        $('btn-extract').textContent = 'Extract with AI Ctrl+Enter';
      }
    }

    // ------------------------------
    // Export
    // ------------------------------
    function collectFormData(){
      const get = (id) => $(id)?.value ?? '';

      const payload = {
        metadata: {
          deal_name: get('dealname') || null,
          borrower_name: get('borrowername') || null,
          industry: get('industry') || null,
          reporting_currency: (get('currency') || null),
          units_scale: Number(get('unitsscale') || 1)
        },
        financials: {
          income_statement: {
            period_end_date: get('periodend') || null,
            period_months: Number(get('periodmonths') || 12),
            revenue: parseNumberLoose(get('revenue')),
            ebitda: parseNumberLoose(get('ebitda')),
            ebitda_margin_percent: parseNumberLoose(get('ebitdamargin')),
            net_income: parseNumberLoose(get('netincome'))
          }
        },
        debt_structure: {
          tranche: {
            tranche_name: get('tranchename') || null,
            tranche_type: get('tranchetype') || null,
            commitment: parseNumberLoose(get('commitment')),
            drawn_amount: parseNumberLoose(get('drawn')),
            maturity_date: get('maturity') || null,
            margin_bps: parseNumberLoose(get('marginbps'))
          }
        },
        credit_metrics: {
          ltm: {
            as_of_date: get('asofdate') || null,
            total_debt: parseNumberLoose(get('totaldebt')),
            net_debt: parseNumberLoose(get('netdebt')),
            total_leverage_x: parseNumberLoose(get('totallev')),
            net_leverage_x: parseNumberLoose(get('netlev')),
            interest_coverage_x: parseNumberLoose(get('interestcov')),
            fixed_charge_coverage_x: parseNumberLoose(get('fccr'))
          }
        },
        extraction: {
          model: appState.model,
          confidence_threshold: appState.confidenceThreshold,
          ai_result: appState.aiResult,
          raw_text_chars: appState.rawText ? appState.rawText.length : 0
        },
        validation: {
          issues: appState.issues
        },
        export_meta: {
          exported_at: new Date().toISOString()
        }
      };

      return payload;
    }

    function buildExportJsonString(){
      return JSON.stringify(collectFormData(), null, 2);
    }

    function buildExportCsv(){
      // Flat, analyst-friendly snapshot.
      const data = collectFormData();
      const rows = [];
      const add = (k, v) => rows.push([k, (v === null || v === undefined) ? '' : String(v)]);

      add('deal_name', data.metadata.deal_name);
      add('borrower_name', data.metadata.borrower_name);
      add('industry', data.metadata.industry);
      add('reporting_currency', data.metadata.reporting_currency);
      add('units_scale', data.metadata.units_scale);

      add('period_end_date', data.financials.income_statement.period_end_date);
      add('period_months', data.financials.income_statement.period_months);
      add('revenue', data.financials.income_statement.revenue);
      add('ebitda', data.financials.income_statement.ebitda);
      add('ebitda_margin_percent', data.financials.income_statement.ebitda_margin_percent);
      add('net_income', data.financials.income_statement.net_income);

      add('tranche_name', data.debt_structure.tranche.tranche_name);
      add('tranche_type', data.debt_structure.tranche.tranche_type);
      add('commitment', data.debt_structure.tranche.commitment);
      add('drawn_amount', data.debt_structure.tranche.drawn_amount);
      add('maturity_date', data.debt_structure.tranche.maturity_date);
      add('margin_bps', data.debt_structure.tranche.margin_bps);

      add('ltm_as_of_date', data.credit_metrics.ltm.as_of_date);
      add('ltm_total_debt', data.credit_metrics.ltm.total_debt);
      add('ltm_net_debt', data.credit_metrics.ltm.net_debt);
      add('ltm_total_leverage_x', data.credit_metrics.ltm.total_leverage_x);
      add('ltm_net_leverage_x', data.credit_metrics.ltm.net_leverage_x);
      add('ltm_interest_coverage_x', data.credit_metrics.ltm.interest_coverage_x);
      add('ltm_fixed_charge_coverage_x', data.credit_metrics.ltm.fixed_charge_coverage_x);

      // CSV
      const escape = (s) => {
        const str = String(s ?? '');
        if (/[",\n]/.test(str)) return '"' + str.replace(/"/g,'""') + '"';
        return str;
      };
      return rows.map(r => r.map(escape).join(',')).join('\n');
    }

    function exportData(){
      validateAll();
      setActiveTab('tab-review');
      const jsonStr = buildExportJsonString();
      const csvStr = buildExportCsv();
      // Populate review box (already renders summary)
      $('aiJson').value = $('aiJson').value || (appState.aiResult ? JSON.stringify(appState.aiResult, null, 2) : '');
      $('reviewSummary').value = $('reviewSummary').value; // keep

      // Download as files
      const name = ($('dealname').value || 'deal').replace(/[^a-z0-9-_]+/gi,'_').slice(0, 60);
      downloadText(`${name}.json`, jsonStr, 'application/json');
      downloadText(`${name}.csv`, csvStr, 'text/csv');
      log('info', 'Exported JSON + CSV (downloaded).');
    }

    function downloadText(filename, content, mime){
      const blob = new Blob([content], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 5000);
    }

    async function copyToClipboard(text){
      try{
        await navigator.clipboard.writeText(text);
        log('info', 'Copied to clipboard.');
      } catch (err){
        log('warn', 'Clipboard failed (browser may block on file://). Use downloaded exports instead.');
      }
    }

    // ------------------------------
    // Clear
    // ------------------------------
    function clearAll(){
      if (!confirm('Clear all in-memory data? This cannot be undone.')) return;
      // Inputs
      for (const id of fieldOrder){
        const el = $(id);
        if (!el) continue;
        if (el.tagName === 'SELECT'){
          // keep defaults for some
          if (id === 'unitsscale') el.value = '1';
          else if (id === 'periodmonths') el.value = '12';
          else el.value = '';
        } else {
          el.value = '';
        }
        el.classList.remove('valid','invalid');
        const vEl = $(id + '-validation');
        if (vEl) vEl.textContent = '';
        const cEl = $(id + '-confidence');
        if (cEl) cEl.innerHTML = '';
      }

      $('aiJson').value = '';
      $('rawText').value = '';
      logEl.value = '';

      appState.rawText = '';
      appState.aiResult = null;
      appState.suggestions.clear();
      appState.issues = [];
      issueCursor = -1;

      renderIssues();
      renderCompletion();
      renderReviewSummary();
      log('info', 'Cleared.');

      focusField('dealname');
    }

    // ------------------------------
    // Error UX
    // ------------------------------
    function showUserError(title, err){
      const msg = (err && err.message) ? err.message : String(err);
      log('error', `${title}: ${msg}`);
      alert(`${title}\n\n${msg}\n\nTip: If you opened index.html from disk (file://), some browsers restrict clipboard and some network calls. Try Chrome/Edge or allow network access.`);
    }

    // ------------------------------
    // Init
    // ------------------------------
    validateApiKey();
    validateFile();
    renderCompletion();
    validateAll();
    focusField('dealname');

  })();
  </script>
</body>
</html>
